# 后端软件架构

## 一、概述

本系统是一个基于 Electron + LangChain/DeepAgents 的桌面端有声绘本生成应用。后端采用 Express 提供 REST API，与前端通过 Electron IPC 通信，核心 Agent 基于 Deepagents.js 实现多步工作流，支持 LLM 与多模态模型（VL/TTS/T2I）的调度。

---

## 二、基础流程
启动软件进入配置页面，输入appkey。选择案例，按session初始化案例对应的agent，输入想要的绘本内容，agent进行规划，按规划进行模型调度，包括llm和多模态模型。生成最终产物，包括图片和音频，存档到工作空间。

**详细流程**

- **启动与配置**：首次启动需进入配置页输入 API Key；后续启动直接进入欢迎页。欢迎页提供配置按钮，可随时修改配置。
- **会话初始化**：选择案例或历史记录均可初始化 AgentRuntime；选择历史记录时需按 session 加载对应历史。
- **Agent 实例化**：按案例配置实例化 Agent，工作流支持通过配置加载不同案例。
- **HITL 系统**：关键操作需人工确认；结合 checkpoint 支持任意时刻暂停与恢复，可停止任意时长。
- **推理系统**：
  - LLM：基于 OpenAI Chat 兼容接口，可切换 LangChain 其他 provider，使用 llm_apikey。
  - 多模态：兼容各厂商 VL、TTS、T2I 等能力，可扩展；模型由 ai_models.json 配置。
- **链路追踪**：通过 LangSmith 追踪 LLM 与多模态调用，记录 provider、URL、模型等信息。
- **Session 与 Workspace**：按 sessionId 管理会话与工作目录，产物归档到对应 workspace。


**典型案例**
典型是百科类型绘本的生成：
1. 选择百科案例。
2. 输入想生成的百科内容。
3. 确认图片描述。
4. 确认台词。
5. 生成语音。
6. 确认台词序号在图片上的位置。



**主要模块**
1. **session 管理**：通过 sessionId 加载会话；SessionRepository（domain）+ SessionFsRepository（infrastructure）。
2. **workspace 管理**：按 sessionId 保存图片、音频等产物；ArtifactRepository + WorkspaceFilesystem。
3. **用户配置管理**：userData 下 config.json（electron-store），ConfigRepository 封装。
4. **agent 管理**：按 main_agent_config 配置化创建主 Agent、SubAgent、Tool（registry 配置驱动）。
5. **inference 管理**：domain 定义端口与类型，infrastructure 实现 getAIConfig、MultimodalPortImpl、adapters（llm/vl/tts/t2i）；LLM 与多模态均依赖注入，由 ai_models.json + app-config 提供 endpoint、model。
6. **tools**：业务语义封装（line_numbers、HITL、config/tools 消费），调用 getMultimodalPortAsync() 或注入的 MultimodalPort。
7. **subagents**：如 prompt_generator，按 sub_agents 配置加载。

**架构要点**
- MCP 已统一为 tools 段配置，config_path 指向 config/tools/*.yaml；能力由 MultimodalPortImpl + infrastructure/adapters 提供。
- LLM 与多模态推理均通过 getAIConfig 构建 adapter/端口，依赖倒置注入到 Agent、Tools。

---

## 三、目录结构

```
backend/
├── agent/                    # Agent 核心
│   ├── AgentFactory.ts       # Agent 工厂：配置驱动创建 Tool（registry）、LLM、MultimodalPort
│   ├── ConfigLoader.ts       # 主配置加载器（main_agent_config.yaml）
│   ├── config.ts             # loadConfig 入口（re-export app-config）
│   ├── fs-routes.ts          # 文件系统 API 路由（委托 ArtifactRepository）
│   ├── session-routes.ts     # Session CRUD API 路由（委托 SessionRepository）
│   ├── LLMCallbacks.ts       # LLM 回调（LangSmith 等）
│   ├── langsmith.ts          # LangSmith 环境初始化
│   └── langsmith-trace.ts    # 多模态调用 trace（VL/TTS/T2I）写入 LangSmith
├── domain/                   # 领域层（接口与类型）
│   ├── inference/            # 推理：Sync/AsyncInferencePort、MultimodalPort、types、value-objects
│   ├── session/              # SessionRepository、实体、值对象
│   ├── workspace/            # ArtifactRepository
│   └── configuration/        # ConfigRepository
├── infrastructure/           # 基础设施（实现端口与仓储）
│   ├── inference/            # ai-config、multimodal-port-impl、create-ports、adapters(llm/vl/tts/t2i)、bases
│   ├── persistence/          # session、workspace、configuration 仓储实现
│   └── repositories.ts       # 工厂：getSessionRepository、getArtifactRepository、createMultimodalPort
├── tools/                    # 工具层（业务语义封装，config_path → config/tools/*.yaml）
│   ├── registry.ts           # 工具注册表与 createTool(name, config, context)
│   ├── index.ts
│   ├── annotate-numbers.ts
│   ├── line-numbers.ts
│   ├── annotate-image-numbers.ts
│   ├── generate-image.ts
│   ├── synthesize-speech.ts
│   ├── generate-script-from-image.ts
│   ├── finalize-workflow.ts
│   └── delete-artifacts.ts
├── services/                 # 核心服务
│   ├── service-initializer.ts  # 服务初始化入口
│   ├── fs.ts                 # WorkspaceFilesystem、getWorkspaceFilesystem、resolveWorkspaceRoot
│   ├── audio-format.ts       # pcmToMp3、pcmToWav
│   ├── runtime-manager.ts    # AgentRuntime 管理（按 sessionId）
│   ├── persistence-service.ts # Checkpoint 持久化
│   ├── workspace-checkpoint-saver.ts # LangGraph checkpoint 存到 session/checkpoints/
│   ├── workspace-service.ts  # Workspace 增强（配额、权限、审计）
│   ├── hitl-service.ts       # HITL 人工确认
│   ├── log-manager.ts        # 日志（audit、hitl、system、llm）
│   └── sync-audio-to-store.ts  # 音频同步到目标目录
├── config/                   # 配置
│   ├── main_agent_config.yaml  # agent、tools（config_path → config/tools/*）、sub_agents、workflow
│   ├── ai_models.json        # 各 provider 下 llm/vl/tts/t2i 的 endpoint、model 等
│   ├── tools/                # 工具业务参数（t2i.yaml、tts.yaml、vl_script.yaml）
│   ├── hitl-config.ts
│   ├── workspace-config.ts
│   ├── sub_agents/
│   │   └── prompt_gen.yaml
│   └── ...
└── app-config.ts             # 应用配置（electron-store，userData/config.json）
```

---

## 四、模块关系

| 模块 | 职责 | 依赖 |
|------|------|------|
| **AgentFactory** | 按 main_agent_config 的 tools 段创建 Tool（registry.createTool），构建 LLM 与 MultimodalPort 时调用 getAIConfig | ConfigLoader、infrastructure/inference/ai-config、adapters/llm、runtime-manager、hitl-service、tools/registry |
| **RuntimeManager** | 按 sessionId 管理 AgentRuntime（workspace、persistence、log、hitl） | fs、persistence-service、log-manager |
| **WorkspaceFilesystem** | 按 sessionId 读写 workspaces/{sessionId}/，路径安全校验；根目录由 getWorkspaceBase()（cwd/outputs 或 JIAOJIAO_WORKSPACE_ROOT） | 无 |
| **getAIConfig**（infrastructure/inference/ai-config） | 从 app-config + ai_models.json 解析 provider、apiKey、model、endpoint（及 T2I 的 taskEndpoint、轮询参数） | app-config |
| **adapters/llm** | 创建 ChatOpenAI，支持 dashscope/zhipu，仅 endpoint | getAIConfig |
| **MultimodalPortImpl** | VL/T2I/TTS 统一入口：resolve 输入、trace、调用 Sync/Async 端口、写 workspace；VL 同步、T2I 异步 submit+poll、TTS 同步（智谱 PCM / 通义 audioUrl） | create-ports 创建的 vlPort/t2iPort/ttsSyncPort、artifactRepo、langsmith-trace |
| **Tools（generate_image、synthesize_speech、generate_script_from_image 等）** | 业务语义封装、HITL、line_numbers/appendEntries、config/tools 消费；调用 getMultimodalPortAsync() 获取端口后执行 | getMultimodalPortAsync、ArtifactRepository、config/tools/*.yaml |
| **HITLService** | 通过 Electron IPC 向前端请求确认，返回 merged payload | 前端 hitl 响应 |

---

## 五、REST API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/sessions | 创建会话，创建 Runtime |
| GET | /api/sessions | 会话列表 |
| GET | /api/sessions/:sessionId | 会话详情（含 images、audio、llm_logs） |
| PATCH | /api/sessions/:sessionId | 更新会话元数据 |
| DELETE | /api/sessions/:sessionId | 删除会话，关闭 Runtime |

---

## 六、配置体系

| 配置 | 位置 | 说明 |
|------|------|------|
| **config.json** | userData（electron-store） | API Key、provider、model、outputPath、storage 等 |
| **main_agent_config.yaml** | backend/config | 主 Agent、**tools**（含 generate_image、synthesize_speech、generate_script_from_image 等）、SubAgent、workflow；tools 段使用 config_path 指向 config/tools/*.yaml |
| **ai_models.json** | backend/config | 各 provider 下 llm/vl/tts/t2i 的 endpoint、model、default 与 models 列表；T2I 含 taskEndpoint、poll_interval_ms、max_poll_attempts |
| **config/tools/*.yaml** | backend/config/tools | t2i.yaml、tts.yaml、vl_script.yaml：工具业务参数（default_params、prompt 等），endpoint 由 ai_models.json + ai-config 提供 |
| **sub_agents/*.yaml** | backend/config/sub_agents | SubAgent 提示词与配置 |

---

## 七、Tools 与 SubAgents 说明

### Tools（配置驱动，main_agent_config.yaml 的 tools 段）

- **generate_image**：文生图，config_path → config/tools/t2i.yaml；HITL 确认 prompt 后调用 MultimodalPort.generateImage()
- **synthesize_speech**：台词合成语音，config_path → config/tools/tts.yaml；readLineNumbers、HITL 确认后 synthesizeSpeech({ items })、appendEntries
- **generate_script_from_image**：以图生剧本（台词+坐标），config_path → config/tools/vl_script.yaml；HITL 后 generateScriptFromImage()
- **annotate_image_numbers**：在图片上标注序号，HITL 确认 annotations 后执行
- **delete_artifacts**：删除 session 下产物，HITL 确认 paths 后执行
- **finalize_workflow**：检查图片/音频/台词是否存在，完成工作流

### SubAgents

- **prompt_generator**：根据用户输入生成文生图提示词，写入 `image_prompt.txt`；支持 `createAgent` 或 `createDeepAgent`，可配置 FilesystemMiddleware

### HITL 动作类型

- `ai.text2image`、`ai.text2speech`、`ai.vl_script`、`ai.image_label_order`、`artifacts.delete`

---

## 八、Checkpoint 与持久化

- **WorkspaceCheckpointSaver**：按 `thread_id`（即 sessionId）将 LangGraph checkpoint 存到 `workspaces/{sessionId}/checkpoints/`
- **PersistenceService**：管理 CheckpointSaver 生命周期，支持 `closeCheckpointer(sessionId)`
- **HITL 与 checkpoint**：工具执行前 HITL 等待；用户取消时工具抛错，当前 run 结束；再次发消息时从 checkpoint 恢复，可重新进入同一 HITL 并继续

---

## 九、链路追踪

- **LLM**：LangChain 默认通过 `LANGCHAIN_TRACING_V2`、`LANGCHAIN_API_KEY` 上报
- **多模态**：infrastructure/inference 的 MultimodalPortImpl 在 generateImage、synthesizeSpeech、generateScriptFromImage 内通过 `traceAiRun` 写入 LangSmith，记录 provider、model、精简 inputs/outputs

---

## 十、日志规范

**原则**：能被 LangSmith 覆盖的日志视为冗余，应避免输出。

| 类型 | 覆盖方 | 处理 |
|------|--------|------|
| LLM 调用（start/end/inputs/outputs） | LangSmith | 不输出 console |
| 多模态调用（TTS/T2I/VL 的 cfg、body、inputs/outputs） | traceAiRun → LangSmith | 不输出 console |
| Agent 工具调用（t2i、tts、vl_script、finalize_workflow 等执行信息） | LangSmith trace | 不输出 console |
| Agent 初始化（配置加载、工具注册、SubAgent 创建） | 无 | 不输出（非 trace，且易刷屏） |
| 错误/警告（`console.error`、`console.warn`） | 无 | 保留 |
| 系统事件（服务启动、关闭、runtime 创建） | 无 | 保留（logManager.logSystem） |
| LangSmith 启用/禁用提示 | 无 | 保留（启动时一次） |

**保留的日志**：`console.error`、`console.warn` 用于异常与需用户关注的事项；`logManager.logSystem` 用于系统级事件；测试脚本中的 `console.log` 用于调试输出。

---

## 十一、Electron IPC 通道

| 通道 | 说明 |
|------|------|
| config | 配置读写、ai_models.json 加载 |
| storage | 存储路径、输出目录 |
| agent | Agent 创建、invoke、stream |
| session | 会话 CRUD |
| filesystem | 工作空间文件 |
| hitl | HITL 确认请求与响应 |
