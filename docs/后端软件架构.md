# 后端软件架构

## 一、概述

本系统是基于 **Electron + React + deepagents.js** 的桌面端有声绘本生成应用。后端运行在 Electron 主进程中，**通过 IPC 与渲染进程通信**（无独立 HTTP 服务）。Agent 基于 deepagents.js（LangChain/LangGraph），按 `main_agent_config.yaml` 配置化创建主 Agent、SubAgent 与 Tool，支持 LLM 与多模态模型（VL/TTS/T2I）的调度，产物按 session 归档到工作空间。

---

## 二、基础流程

启动软件进入配置页面，输入 API Key。选择案例，按 session 初始化案例对应的 Agent，输入想要的绘本内容；Agent 进行规划，按规划调度 LLM 与多模态模型，生成图片与音频，存档到工作空间。

**详细流程**

- **启动与配置**：首次启动需进入配置页输入 API Key；后续启动直接进入欢迎页。欢迎页提供配置按钮，可随时修改配置。
- **会话初始化**：选择案例或历史记录均可初始化 AgentRuntime；选择历史记录时需按 session 加载对应历史。
- **Agent 实例化**：按 `main_agent_config.yaml` 实例化 Agent，工作流支持通过配置加载不同案例。
- **HITL 系统**：关键操作需人工确认；结合 checkpoint 支持任意时刻暂停与恢复。
- **推理系统**：
  - LLM：基于 OpenAI Chat 兼容接口，可切换通义/智谱等，使用 app-config 中的 apiKey。
  - 多模态：VL、TTS、T2I 由 `ai_models.json` + app-config 提供 endpoint、model，infrastructure 层 adapters 实现。
- **链路追踪**：通过 LangSmith 追踪 LLM 与多模态调用。
- **Session 与 Workspace**：按 sessionId 管理会话与工作目录，产物归档到 `workspaces/{sessionId}/`。

**典型案例（百科绘本）**

1. 选择百科案例  
2. 输入想生成的百科内容  
3. 确认图片描述  
4. 确认台词  
5. 生成语音  
6. 确认台词序号在图片上的位置  

**主要模块**

| 模块 | 说明 |
|------|------|
| **Session** | SessionRepository（domain）+ SessionFsRepository（infrastructure）；应用层 create/list/get/update/delete 用例，IPC 调用用例。 |
| **Workspace** | 按 sessionId 保存图片、音频等；ArtifactRepository + WorkspaceFilesystem。 |
| **用户配置** | userData 下 config.json（electron-store），ConfigRepository 封装，ConfigElectronStoreRepository 实现。 |
| **Agent** | AgentFactory + ConfigLoader，按 main_agent_config 创建主 Agent、SubAgent、Tool（tools 段 config_path → config/tools/*.yaml）。 |
| **Inference** | domain 定义端口与类型；infrastructure 实现 getAIConfig、MultimodalPortImpl、adapters（llm/vl/tts/t2i）；LLM 与多模态依赖注入。 |
| **Tools** | 业务语义封装（registry.createTool、config/tools 消费），调用 getMultimodalPortAsync() 或注入的 MultimodalPort。 |
| **SubAgents** | 如 prompt_generator，按 sub_agents 配置加载。 |

**架构要点**

- 工具统一由 main_agent_config 的 **tools** 段配置，config_path 指向 `config/tools/*.yaml`；能力由 MultimodalPortImpl + infrastructure/adapters 提供。
- LLM 与多模态均通过 getAIConfig 构建 adapter/端口，依赖倒置注入到 Agent、Tools。

---

## 三、目录结构

```
backend/
├── agent/                          # Agent 核心
│   ├── AgentFactory.ts             # 配置驱动创建主 Agent、Tool（registry）、LLM、MultimodalPort、Checkpointer
│   ├── ConfigLoader.ts             # 主配置加载（main_agent_config.yaml、sub_agents、tools）
│   ├── langsmith.ts                # LangSmith 环境初始化
│   └── langsmith-trace.ts          # 多模态调用 trace 写入 LangSmith
├── application/                    # 应用层（用例）
│   ├── agent/                      # 会话与 Agent 用例
│   │   ├── index.ts
│   │   ├── create-session-use-case.ts
│   │   ├── list-sessions-use-case.ts
│   │   ├── get-session-use-case.ts
│   │   ├── update-session-use-case.ts
│   │   ├── delete-session-use-case.ts
│   │   └── invoke-agent-use-case.ts
│   ├── session/
│   └── helpers/
│       └── resolve-step-result-paths.ts
├── interfaces/
│   └── http/                       # HTTP 接口层（可选，当前 Electron 未挂载）
│       ├── index.ts
│       ├── session-routes.ts      # Session CRUD 委托应用层用例
│       └── fs-routes.ts            # 文件系统委托 ArtifactRepository
├── domain/                         # 领域层
│   ├── inference/                  # 推理：端口、类型、值对象
│   │   ├── ports/                  # SyncInferencePort、AsyncInferencePort、MultimodalPort
│   │   ├── value-objects/
│   │   ├── types.ts
│   │   └── index.ts
│   ├── session/                    # Session 实体、SessionRepository
│   ├── workspace/                  # ArtifactRepository
│   └── configuration/              # ConfigRepository
├── infrastructure/                  # 基础设施
│   ├── inference/                  # ai-config、multimodal-port-impl、create-ports、adapters(llm/vl/tts/t2i)、bases
│   ├── persistence/                 # 仓储实现
│   │   ├── session/
│   │   ├── workspace/
│   │   └── configuration/         # ConfigElectronStoreRepository
│   ├── repositories.ts             # getSessionRepository、getArtifactRepository、createMultimodalPort 等
│   └── index.ts
├── tools/                           # 工具实现（registry + 各工具）
│   ├── registry.ts                 # 工具注册表、createTool(name, config, context)
│   ├── index.ts
│   ├── annotate-numbers.ts
│   ├── annotate-image-numbers.ts
│   ├── generate-image.ts
│   ├── synthesize-speech.ts
│   ├── generate-script-from-image.ts
│   ├── finalize-workflow.ts
│   ├── delete-artifacts.ts
│   └── line-numbers.ts
├── services/                        # 核心服务
│   ├── service-initializer.ts      # 服务初始化入口
│   ├── fs.ts                       # WorkspaceFilesystem、resolveWorkspaceRoot
│   ├── audio-format.ts             # pcmToMp3、pcmToWav
│   ├── runtime-manager.ts          # AgentRuntime 管理（按 sessionId）
│   ├── persistence-service.ts      # Checkpoint 持久化、closeCheckpointer
│   ├── workspace-checkpoint-saver.ts # LangGraph checkpoint 存到 workspaces/{sessionId}/checkpoints/
│   ├── workspace-service.ts
│   ├── hitl-service.ts             # HITL 人工确认（IPC 与前端交互）
│   ├── log-manager.ts              # 日志（audit、hitl、system、llm）
│   └── sync-audio-to-store.ts
├── config/                          # 配置
│   ├── main_agent_config.yaml      # 主 Agent、tools（config_path）、sub_agents、workflow
│   ├── ai_models.json              # 各 provider 下 llm/vl/tts/t2i 的 endpoint、model 等
│   ├── tools/                      # 工具业务参数（t2i.yaml、tts.yaml、vl_script.yaml）
│   ├── sub_agents/
│   │   └── prompt_gen.yaml
│   ├── hitl-config.ts
│   ├── workspace-config.ts
│   ├── log-config.ts
│   └── feature-flags.ts
├── app-config.ts                    # 应用配置（electron-store，userData/config.json）
├── workspace-notifier.ts
└── utils/
    └── storage.ts
```

---

## 四、模块关系

| 模块 | 职责 | 依赖 |
|------|------|------|
| **AgentFactory** | 按 main_agent_config 创建 Tool（registry.createTool）、LLM、MultimodalPort、Checkpointer | ConfigLoader、ai-config、adapters/llm、runtime-manager、hitl-service、tools/registry |
| **RuntimeManager** | 按 sessionId 管理 AgentRuntime（workspace、persistence、log、hitl） | fs、persistence-service、log-manager |
| **WorkspaceFilesystem** | 按 sessionId 读写 workspaces/{sessionId}/，路径安全校验 | 无 |
| **getAIConfig**（ai-config） | 从 app-config + ai_models.json 解析 provider、apiKey、model、endpoint | app-config |
| **adapters/llm** | 创建 ChatOpenAI，支持 dashscope/zhipu | getAIConfig |
| **MultimodalPortImpl** | VL/T2I/TTS 统一入口：resolve 输入、trace、调用 Sync/Async 端口、写 workspace | create-ports、artifactRepo、langsmith-trace |
| **Tools** | 业务语义封装、HITL、调用 getMultimodalPortAsync() | getMultimodalPortAsync、ArtifactRepository、config/tools/*.yaml |
| **HITLService** | 通过 Electron IPC 向前端请求确认，返回 merged payload | 前端 hitl 响应 |

---

## 五、前端与后端交互（Electron IPC）

当前桌面端**仅通过 IPC** 与主进程通信，无独立 REST 服务。`backend/interfaces/http` 下的 Session 与文件系统路由已实现（委托应用层用例），可供本地 HTTP 服务或测试挂载，但 **Electron 主进程未挂载 Express**。

| IPC 通道前缀 | 说明 |
|--------------|------|
| **session:** | session:create、session:list、session:get、session:update、session:delete |
| **agent:** | agent:sendMessage（流式）、agent:stopStream、agent:quotaExceeded（推送） |
| **config:** | config:get、config:set、config:getAiModels、config:getWorkspaceDir、config:openConfigDir、config:showOutputPathDialog、config:openFolder |
| **fs:** | fs:ls、fs:readFile、fs:getFilePath、fs:glob、fs:grep |
| **hitl:** | hitl:respond、hitl:getPendingRequests、hitl:cancel |
| **sync:** | sync:audioToStore |
| **storage:** | storage:getHistory、storage:saveHistory、storage:getBook、storage:saveBook |

---

## 六、配置体系

| 配置 | 位置 | 说明 |
|------|------|------|
| **config.json** | userData（electron-store） | API Key、provider、model、outputPath、storage 等 |
| **main_agent_config.yaml** | backend/config | 主 Agent、tools（含 generate_image、synthesize_speech、generate_script_from_image 等）、SubAgent、workflow；tools 段 config_path 指向 config/tools/*.yaml |
| **ai_models.json** | backend/config | 各 provider 下 llm/vl/tts/t2i 的 endpoint、model；T2I 含 taskEndpoint、poll 参数等 |
| **config/tools/*.yaml** | backend/config/tools | t2i.yaml、tts.yaml、vl_script.yaml：工具业务参数 |
| **sub_agents/*.yaml** | backend/config/sub_agents | SubAgent 提示词与配置 |

---

## 七、Tools 与 SubAgents

### Tools（main_agent_config.yaml 的 tools 段）

- **generate_image**：文生图，config_path → config/tools/t2i.yaml；HITL 确认后 MultimodalPort.generateImage()
- **synthesize_speech**：台词合成语音，config_path → config/tools/tts.yaml；readLineNumbers、HITL 后 synthesizeSpeech、appendEntries
- **generate_script_from_image**：以图生剧本（台词+坐标），config_path → config/tools/vl_script.yaml；HITL 后 generateScriptFromImage()
- **annotate_image_numbers**：在图片上标注序号，HITL 确认后执行
- **delete_artifacts**：删除 session 下产物，HITL 确认 paths 后执行
- **finalize_workflow**：检查图片/音频/台词是否存在，完成工作流

### SubAgents

- **prompt_generator**：根据用户输入生成文生图提示词，写入 `image_prompt.txt`；config_path → config/sub_agents/prompt_gen.yaml

### HITL 动作类型

- `ai.text2image`、`ai.text2speech`、`ai.vl_script`、`ai.image_label_order`、`artifacts.delete`

---

## 八、Checkpoint 与持久化

- **WorkspaceCheckpointSaver**：按 `thread_id`（即 sessionId）将 LangGraph checkpoint 存到 `workspaces/{sessionId}/checkpoints/`
- **PersistenceService**：管理 CheckpointSaver 生命周期，支持 `closeCheckpointer(sessionId)`
- **HITL 与 checkpoint**：工具执行前 HITL 等待；用户取消时工具抛错，当前 run 结束；再次发消息时从 checkpoint 恢复

---

## 九、链路追踪

- **LLM**：LangChain 通过 LANGCHAIN_TRACING_V2、LANGCHAIN_API_KEY 上报
- **多模态**：MultimodalPortImpl 在 generateImage、synthesizeSpeech、generateScriptFromImage 内通过 traceAiRun 写入 LangSmith

---

## 十、日志规范

| 类型 | 覆盖方 | 处理 |
|------|--------|------|
| LLM 调用 | LangSmith | 不输出 console |
| 多模态调用 | traceAiRun → LangSmith | 不输出 console |
| Agent 工具调用 | LangSmith trace | 不输出 console |
| 错误/警告 | 无 | 保留 console.error / console.warn |
| 系统事件 | 无 | 保留 logManager.logSystem |

---

## 十一、扩展开发

- **新增工具**：在 `backend/tools/` 实现工具逻辑，在 `registry.ts` 中注册；在 main_agent_config.yaml 的 tools 段添加条目，必要时增加 config/tools/*.yaml。
- **新增子代理**：在 config/sub_agents/ 添加 YAML，在 main_agent_config.yaml 的 sub_agents 段配置。
- **新增推理能力**：在 domain/inference 定义端口或类型，在 infrastructure/inference/adapters 或 create-ports 中实现，由 getAIConfig + ai_models.json 提供配置。

更多 DDD 与分层说明见 [DDD核心概念及桌面端后端迁移指南](./DDD核心概念及桌面端后端迁移指南.md)。
