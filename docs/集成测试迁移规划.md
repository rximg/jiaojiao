# 集成测试迁移规划

> 将后端测试收敛为三个维度的集成测试：**Inference 层**、**Tools 层**、**Agent 层**。去除单元测试及其他分散测试，统一迁移方案。

---

## 一、测试策略概述

### 1.1 原则

- **仅保留集成测试**：不编写单元测试，通过集成测试覆盖各层行为。
- **三层维度**：Inference → Tools → Agent，逐层验证，上层依赖下层。
- **可运行性**：Inference 与 Tools 层支持 mock provider 或真实 API；Agent 层需真实 API 或完整 mock 链。

### 1.2 三层测试维度

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Agent 层集成测试                                                             │
│  - AgentFactory 创建主 Agent / SubAgent                                       │
│  - Agent 完整 invoke / stream 流程                                            │
│  - 依赖：Tools 层 + Inference 层（可 mock 或真实）                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Tools 层集成测试                                                             │
│  - synthesizeSpeech、generateImage、generateScriptFromImage、finalize_workflow │
│  - 按 session、workspace 组织输入输出                                         │
│  - 依赖：Inference 层（可 mock 或真实）                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Inference 层集成测试                                                         │
│  - LLM、TTS、T2I、VL 各 provider 适配器                                       │
│  - 直接调用 ai/llm、ai/tts、ai/t2i、ai/vl 的导出函数                           │
│  - 支持 mock fetch 或真实 API（需 RUN_INTEGRATION_TESTS + API Key）            │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、各层测试范围

### 2.1 Inference 层

| 能力 | 测试内容 | 现有对应 |
|------|----------|----------|
| **LLM** | `createLLMFromAIConfig` 创建模型，`invoke` 返回非空内容 | `llm.test.ts`、`ai-llm.test.ts` |
| **TTS** | DashScope/Zhipu 适配器：submit→poll 或 一次请求→PCM | `ai-t2i.test.ts` 风格（mock fetch） |
| **T2I** | DashScope/Zhipu：submitTask、pollForImageUrl 返回 URL | `ai-t2i.test.ts` |
| **VL** | DashScope/Zhipu：callVL 返回 content | `ai-vl.test.ts`、`vl.test.ts` |
| **Config** | `getAIConfig` 按 provider 返回正确配置 | `ai-config.test.ts` |

**合并为**：`tests/integration/inference/` 下统一入口，按 provider（dashscope/zhipu）分 describe，支持 `mock fetch` 或真实 API。

### 2.2 Tools 层

| Tool | 测试内容 | 现有对应 |
|------|----------|----------|
| **synthesizeSpeech** | 输入 texts/scriptFile，输出 audioPaths、audioUris，写入 workspace | `tts.test.ts`、`tts.unit.test.ts` |
| **generateImage** | 输入 prompt/promptFile，输出 imagePath，写入 workspace | `t2i.test.ts`、`t2i.unit.test.ts` |
| **generateScriptFromImage** | 输入 imagePath，输出 script 内容 | `vl.test.ts` 部分 |
| **finalize_workflow** | 检查 images/audio/script 完整性，返回成功/失败消息 | `finalize-workflow.unit.test.ts` |

**合并为**：`tests/integration/tools/` 下统一入口，每个 Tool 一个 describe。Inference 可 mock，重点验证 Tools 的 session/workspace 组织、产物路径、参数解析（PromptInput/TextsInput）。

### 2.3 Agent 层

| 场景 | 测试内容 | 现有对应 |
|------|----------|----------|
| **AgentFactory** | 加载配置、创建主 Agent、验证 nodes 结构 | `backend/tests/test-agent-factory.ts` |
| **Agent invoke** | 完整 invoke，输入主题，验证输出结构 | `backend/tests/test-agent-run.ts` |
| **Agent stream** | 流式调用，验证事件序列（可选） | 暂无 |

**合并为**：`tests/integration/agent/` 下 vitest 用例，或保留 `backend/tests/` 脚本形式，统一通过 `npm run test:agent` 执行。需真实 API 或完整 mock 链。

---

## 三、待移除的测试

| 文件 | 类型 | 处理方式 |
|------|------|----------|
| `tests/tts.unit.test.ts` | 单元 | 删除，逻辑并入 Tools 层集成测试 |
| `tests/llm.unit.test.ts` | 单元 | 删除，逻辑并入 Inference 层集成测试 |
| `tests/vl.unit.test.ts` | 单元 | 删除，逻辑并入 Inference 层集成测试 |
| `tests/t2i.unit.test.ts` | 单元 | 删除，逻辑并入 Tools 层集成测试 |
| `tests/finalize-workflow.unit.test.ts` | 单元 | 删除，逻辑并入 Tools 层集成测试 |
| `tests/ai-config.test.ts` | 配置 | 并入 Inference 层 `getAIConfig` 用例 |
| `tests/ai-llm.test.ts` | 模块 | 并入 Inference 层 LLM 用例 |
| `tests/ai-vl.test.ts` | 模块 | 并入 Inference 层 VL 用例 |
| `tests/ai-t2i.test.ts` | 模块 | 并入 Inference 层 T2I 用例 |

**保留并重构**：

| 文件 | 迁移目标 |
|------|----------|
| `tests/llm.test.ts` | `tests/integration/inference/llm.integration.test.ts` |
| `tests/tts.test.ts` | `tests/integration/tools/tts.integration.test.ts` |
| `tests/t2i.test.ts` | `tests/integration/tools/t2i.integration.test.ts` |
| `tests/vl.test.ts` | 拆分：VL 适配器 → `inference/vl.integration.test.ts`；generateScriptFromImage → `tools/vl.integration.test.ts` |
| `backend/tests/test-agent-factory.ts` | `tests/integration/agent/agent-factory.integration.test.ts` 或保留脚本 |
| `backend/tests/test-agent-run.ts` | `tests/integration/agent/agent-run.integration.test.ts` 或保留脚本 |

---

## 四、目标目录结构

```
tests/
├── integration/
│   ├── inference/                    # Inference 层
│   │   ├── llm.integration.test.ts
│   │   ├── tts.integration.test.ts
│   │   ├── t2i.integration.test.ts
│   │   ├── vl.integration.test.ts
│   │   └── config.integration.test.ts
│   ├── tools/                        # Tools 层
│   │   ├── synthesize-speech.integration.test.ts
│   │   ├── generate-image.integration.test.ts
│   │   ├── generate-script.integration.test.ts
│   │   └── finalize-workflow.integration.test.ts
│   └── agent/                        # Agent 层
│       ├── agent-factory.integration.test.ts
│       └── agent-run.integration.test.ts
└── fixtures/                         # 共享 fixtures（可选）
    └── mock-responses.ts
```

---

## 五、迁移步骤

### 阶段一：整理与删除

1. 删除所有单元测试文件：`tts.unit.test.ts`、`llm.unit.test.ts`、`vl.unit.test.ts`、`t2i.unit.test.ts`、`finalize-workflow.unit.test.ts`。
2. 删除或合并 `ai-config.test.ts`、`ai-llm.test.ts`、`ai-vl.test.ts`、`ai-t2i.test.ts` 至 Inference 层。

### 阶段二：Inference 层集成测试

1. 创建 `tests/integration/inference/` 目录。
2. 合并 `ai-config`、`ai-llm`、`ai-vl`、`ai-t2i` 及 `llm.test.ts`、`vl.test.ts` 中适配器相关用例，形成：
   - `config.integration.test.ts`：`getAIConfig` 按 provider 返回正确配置。
   - `llm.integration.test.ts`：创建 LLM、invoke 返回非空（mock 或真实）。
   - `tts.integration.test.ts`：TTS 适配器 submit/poll 或一次请求（mock fetch）。
   - `t2i.integration.test.ts`：T2I 适配器 submit、poll 返回 URL（mock fetch）。
   - `vl.integration.test.ts`：VL 适配器 callVL 返回 content（mock fetch）。
3. 统一环境变量：`RUN_INTEGRATION_TESTS=true`、`TEST_API_PROVIDER=zhipu|dashscope` 控制是否调用真实 API。

### 阶段三：Tools 层集成测试

1. 创建 `tests/integration/tools/` 目录。
2. 将 `tts.test.ts`、`t2i.test.ts` 迁移为 `synthesize-speech.integration.test.ts`、`generate-image.integration.test.ts`。
3. 从 `vl.test.ts` 抽取 `generateScriptFromImage` 相关用例至 `generate-script.integration.test.ts`。
4. 将 `finalize-workflow.unit.test.ts` 中有价值的用例（文件检查、路径解析、返回格式）迁移为 `finalize-workflow.integration.test.ts`，使用真实 workspace 或临时目录。
5. Inference 层可 mock，重点验证 Tools 的 session 路径、产物写入、参数解析。

### 阶段四：Agent 层集成测试

1. 创建 `tests/integration/agent/` 目录。
2. 将 `backend/tests/test-agent-factory.ts` 转为 vitest 用例，或保留为 `tsx` 脚本，通过 `npm run test:agent:factory` 执行。
3. 将 `backend/tests/test-agent-run.ts` 转为 vitest 用例，或保留为脚本，通过 `npm run test:agent:run` 执行。
4. 需真实 API 时，在 CI 中可选执行；本地开发可跳过或使用 mock 链。

### 阶段五：package.json 脚本更新

```json
{
  "scripts": {
    "test": "vitest",
    "test:run": "vitest run",
    "test:inference": "vitest run tests/integration/inference",
    "test:inference:zhipu": "npx cross-env RUN_INTEGRATION_TESTS=true TEST_API_PROVIDER=zhipu vitest run tests/integration/inference",
    "test:inference:dashscope": "npx cross-env RUN_INTEGRATION_TESTS=true TEST_API_PROVIDER=dashscope vitest run tests/integration/inference",
    "test:tools": "vitest run tests/integration/tools",
    "test:tools:zhipu": "npx cross-env RUN_INTEGRATION_TESTS=true TEST_API_PROVIDER=zhipu vitest run tests/integration/tools",
    "test:tools:dashscope": "npx cross-env RUN_INTEGRATION_TESTS=true TEST_API_PROVIDER=dashscope vitest run tests/integration/tools",
    "test:agent": "vitest run tests/integration/agent",
    "test:agent:run": "npx cross-env RUN_INTEGRATION_TESTS=true tsx backend/tests/test-agent-run.ts",
    "test:all": "vitest run tests/integration"
  }
}
```

---

## 六、与 DDD 架构的对应关系

| 测试层 | DDD 归属 | 说明 |
|--------|----------|------|
| **Inference** | 基础设施层 `inference` 适配器 | 验证防腐层与外部 API 的对接 |
| **Tools** | 应用层 / 领域服务 | 验证 Tools 对推理端口的调用、session/workspace 组织 |
| **Agent** | 应用层 + 领域层 `picture-book` | 验证 AgentFactory、工作流编排、端到端流程 |

---

## 七、注意事项

1. **不编写单元测试**：仅通过三层集成测试覆盖行为，减少 mock 维护成本。
2. **Mock 策略**：Inference 层可用 `vi.fn()` mock `fetch` 验证适配器逻辑；Tools 层可 mock Inference 端口；Agent 层需真实或完整 mock。
3. **CI 执行**：`test:inference`、`test:tools` 默认可无 API Key 运行（mock 模式）；`test:inference:zhipu`、`test:tools:dashscope` 等需配置后执行。
4. **与《后端 DDD 架构划分规划》一致**：本迁移完成后，更新该文档中「测试策略」一节，引用本文档。
