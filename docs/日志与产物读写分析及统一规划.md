# 日志与产物读写统一方案

> 按职责分离：Agent 模块（tools、mcp、subagents、ai/*）使用 FilesystemMiddleware + FilesystemBackend；其他模块（session、日志、checkpoint 等）使用 WorkspaceFilesystem。

---

## 一、职责划分

### 1.1 双轨制原则

| 模块类型 | 使用方式 | 说明 |
|----------|----------|------|
| **Agent 模块**（tools、mcp、subagents、ai/*） | FilesystemMiddleware + FilesystemBackend | Agent 及其 tools 的文件读写统一用 FilesystemBackend，保留跨平台、路径安全等特性 |
| **其他模块**（session-routes、LogManager、checkpoint-saver、fs-routes、persistence 等） | WorkspaceFilesystem | 非 Agent 路径，直接使用现有 workspace 能力 |

### 1.2 划分理由

- **职责清晰**：Agent 及其 tools（含 ai、mcp）的文件操作走 FilesystemBackend；服务、路由、日志等走 WorkspaceFilesystem
- **迁移成本可控**：Agent 及 tools 实现（ai/*、mcp/*）改用 FilesystemBackend；其他模块保持 WorkspaceFilesystem 不变
- **保留封装**：Agent 侧使用 deepagents 内置 FilesystemBackend，不丢失其安全与跨平台特性
- **避免过度统一**：两套实现各司其职，不强行合并

---

## 二、Agent 模块：FilesystemMiddleware

### 2.1 使用方式

```typescript
// Subagents（如 prompt_generator）
const sessionWorkspaceRoot = path.join(workspaceRoot, sessionId);
const fsMiddleware = createFilesystemMiddleware({
  backend: new FilesystemBackend({
    rootDir: sessionWorkspaceRoot,
    virtualMode: true,
  }),
});

// 主 Agent（若需文件能力）
createDeepAgent({
  backend: (config) => new FilesystemBackend({
    rootDir: path.join(workspaceRoot, config.configurable?.thread_id ?? 'default'),
    virtualMode: true,
  }),
  // ...
});
```

### 2.2 覆盖范围

- **Subagents**：prompt_generator 等，通过 FilesystemMiddleware 获得 `read_file`、`write_file`、`ls`、`glob`、`grep` 等工具
- **主 Agent**：若需直接读写文件，通过 `backend` 参数注入 FilesystemBackend
- **Tools / MCP / ai**：generate_image、synthesize_speech、vl_script、annotate_numbers 等由 Agent 调用的 tools，其实现（ai/t2i、ai/tts、ai/vl、mcp/*）内部的文件读写**必须使用 FilesystemBackend**，与 FilesystemMiddleware 保持一致

### 2.3 Tools 实现中的文件读写

ai/*、mcp/* 作为 Agent tools 的实现层，内部读写应通过 FilesystemBackend：

```typescript
// 按 sessionId 获取 Backend 实例
function getBackendForSession(sessionId: string): FilesystemBackend {
  return new FilesystemBackend({
    rootDir: path.join(workspaceRoot, sessionId),
    virtualMode: true,
  });
}

// ai/t2i、ai/tts、ai/vl、mcp/* 内部
const backend = getBackendForSession(sessionId);
await backend.write('/lines/script.json', content);  // 文本用 Backend
```

### 2.4 二进制文件例外

FilesystemBackend.write 仅支持 string。图片（ai/t2i）、音频（ai/tts）等二进制写入，tools 实现中可保留 WorkspaceFilesystem 作为例外，或待 deepagents 提供二进制写入支持后再统一。

---

## 三、其他模块：WorkspaceFilesystem

### 3.1 使用方式

继续使用 `getWorkspaceFilesystem()`，调用 `writeFile`、`readFile`、`ls`、`rm` 等。

### 3.2 覆盖范围

| 模块 | 用途 |
|------|------|
| **session-routes** | meta/session.json、images/.gitkeep、audio/.gitkeep、checkpoints/.gitkeep |
| **LogManager** | 日志可保留 `logs/` 或迁入 `workspaces/{sessionId}/logs/`，通过 WorkspaceFilesystem 写入 |
| **workspace-checkpoint-saver** | checkpoints/ 持久化 |
| **persistence-service** | checkpoint 状态 |
| **fs-routes** | REST API 文件读写 |

### 3.3 特殊处理

- **line-numbers**：`workspaces/audio_record.json` 为全局文件，需扩展 WorkspaceFilesystem 支持全局路径（如 `writeFile(null, 'audio_record.json', ...)` 或 `writeFile('', 'workspaces/audio_record.json', ...)`）
- **ConfigLoader、ai/config**：配置加载非运行时产物，保持 `fs.readFile` 不变

---

## 四、目录结构

```
workspaces/{sessionId}/
├── meta/
│   └── session.json
├── images/
├── audio/
├── checkpoints/
├── lines/
├── logs/                    # 可选：日志迁入时
│   ├── audit.jsonl
│   └── hitl.jsonl
└── ...
```

日志若不迁入，继续使用 `logs/{type}/{date}/`。

---

## 五、实施清单

1. **Agent 侧**：Subagents 已使用 FilesystemMiddleware；主 Agent 若需文件能力，通过 `backend` 参数注入 FilesystemBackend
2. **Tools 实现**：ai/t2i、ai/tts、ai/vl、mcp/* 将 `getWorkspaceFilesystem()` 改为 `getBackendForSession(sessionId)`，使用 FilesystemBackend 进行文件读写
3. **日志**（可选）：LogManager 改为通过 WorkspaceFilesystem 写入 `workspaces/{sessionId}/logs/`，或保持 `logs/` 现状
4. **WorkspaceFilesystem 扩展**：支持全局路径（如 `workspaces/audio_record.json`），供 line-numbers 等使用
5. **依赖注入**（可选）：用例、服务通过构造函数接收 WorkspaceFilesystem 或 Backend 工厂，便于测试与 DDD 迁移
